name: Run FPL Engine

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * FRI"

jobs:
  run-engine:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------------
      # 1. Checkout repo
      # -------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------
      # 2. Set up Python
      # -------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # -------------------------------------------------------
      # 3. Install dependencies
      # -------------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # -------------------------------------------------------
      # 4. Fetch Understat + FotMob HTML via proxy (CI-safe)
      # -------------------------------------------------------

      - name: Download Understat EPL HTML (via jina.ai proxy)
        run: |
          mkdir -p data
          curl -L "https://r.jina.ai/https://understat.com/league/EPL" \
            -H "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)" \
            -H "Accept-Language: en-US,en;q=0.9" \
            -o data/understat_epl.html
          echo "Understat HTML file size:"
          wc -c data/understat_epl.html

      - name: Debug Understat HTML content
        run: |
          echo "First 200 lines of Understat HTML:"
          head -n 200 data/understat_epl.html

      - name: Download FotMob EPL HTML (via jina.ai proxy)
        run: |
          mkdir -p data
          curl -L "https://r.jina.ai/https://www.fotmob.com/leagues/47" \
            -H "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)" \
            -H "Accept-Language: en-US,en;q=0.9" \
            -o data/fotmob_epl.html
          echo "FotMob HTML file size:"
          wc -c data/fotmob_epl.html

      - name: Debug FotMob HTML content
        run: |
          echo "First 200 lines of FotMob HTML:"
          head -n 200 data/fotmob_epl.html


      - name: Build unified expected stats dataset (Understat + FotMob + FPL API)
        run: |
          python -m pip install --quiet unidecode rapidfuzz
          python - << 'EOF'
          import re, json, pandas as pd, requests
          from unidecode import unidecode
          from rapidfuzz import process, fuzz

          # --------------------------------------------------------
          # Utility: normalize names
          # --------------------------------------------------------
          def normalize(s):
              import re
              if not s: return ""
              s = unidecode(str(s)).lower()
              s = re.sub(r"[^a-z ]", " ", s)
              return " ".join(s.split())

          # --------------------------------------------------------
          # 1. Load Understat HTML & extract playersData
          # --------------------------------------------------------
          under_html = open("data/understat_epl.html", "r", encoding="utf-8").read()

          # Match: var playersData = JSON.parse('...'); 
          m = re.search(r"playersData\s*=\s*JSON\.parse\('(.+?)'\)", under_html, re.DOTALL)
          if not m:
              raise RuntimeError("Could not extract Understat playersData JSON")

          raw_json = m.group(1).encode('utf-8').decode('unicode_escape')
          under_data = json.loads(raw_json)

          # Convert Understat data → DataFrame
          under_rows = []
          for p in under_data:
              under_rows.append({
                  "u_norm": normalize(p["player_name"]),
                  "u_team": p["team_title"],
                  "understat_xg": float(p.get("xG", 0)),
                  "understat_xa": float(p.get("xA", 0)),
                  "understat_npxg": float(p.get("npxG", 0)),
                  "understat_minutes": float(p.get("time", 0)),
              })
          udf = pd.DataFrame(under_rows)

          # --------------------------------------------------------
          # 2. Load FotMob HTML & extract __INITIAL_STATE__
          # --------------------------------------------------------
          fot_html = open("data/fotmob_epl.html", "r", encoding="utf-8").read()

          m2 = re.search(r"__INITIAL_STATE__\s*=\s*(\{.*?\})</script>", fot_html, re.DOTALL)
          if not m2:
              raise RuntimeError("Could not extract FotMob INITIAL_STATE JSON")

          fot_data = json.loads(m2.group(1))

          # FotMob table
          fm_rows = []
          for team in fot_data.get("league", {}).get("teams", []):
              for p in team.get("topPlayers", []):
                  fm_rows.append({
                      "f_norm": normalize(p["name"]),
                      "f_team": team["name"],
                      "fotmob_xg": float(p.get("xG", 0)),
                      "fotmob_xa": float(p.get("xA", 0)),
                      "fotmob_minutes_recent": float(p.get("min", 0)),
                      "fotmob_starts_recent": float(p.get("starts", 0)),
                      "fotmob_role": p.get("position", ""),
                      "fotmob_availability": p.get("status", ""),
                  })
          fdf = pd.DataFrame(fm_rows)

          # --------------------------------------------------------
          # 3. Load FPL API Live
          # --------------------------------------------------------
          fpl = requests.get("https://fantasy.premierleague.com/api/bootstrap-static/").json()
          teams = {t["id"]: t["short_name"] for t in fpl["teams"]}

          fpl_rows = []
          for p in fpl["elements"]:
              fpl_rows.append({
                  "web_name": p["web_name"],
                  "team_short": teams[p["team"]],
                  "norm": normalize(p["web_name"]),
              })
          fpldf = pd.DataFrame(fpl_rows)

          # --------------------------------------------------------
          # 4. Hybrid Matching
          # --------------------------------------------------------
          out_rows = []

          for _, row in fpldf.iterrows():
              n = row["norm"]

              # Understat
              u = udf[udf["u_norm"] == n]
              if u.empty:
                  match = process.extractOne(n, udf["u_norm"], scorer=fuzz.token_sort_ratio)
                  if match and match[1] >= 90:
                      u = udf[udf["u_norm"] == match[0]]

              # FotMob
              f = fdf[fdf["f_norm"] == n]
              if f.empty:
                  match = process.extractOne(n, fdf["f_norm"], scorer=fuzz.token_sort_ratio)
                  if match and match[1] >= 90:
                      f = fdf[fdf["f_norm"] == match[0]]

              out_rows.append({
                  "web_name": row["web_name"],
                  "team_short": row["team_short"],

                  "understat_xg": u["understat_xg"].iloc[0] if not u.empty else 0,
                  "understat_xa": u["understat_xa"].iloc[0] if not u.empty else 0,
                  "understat_npxg": u["understat_npxg"].iloc[0] if not u.empty else 0,
                  "understat_minutes": u["understat_minutes"].iloc[0] if not u.empty else 0,

                  "fotmob_xg": f["fotmob_xg"].iloc[0] if not f.empty else 0,
                  "fotmob_xa": f["fotmob_xa"].iloc[0] if not f.empty else 0,
                  "fotmob_minutes_recent": f["fotmob_minutes_recent"].iloc[0] if not f.empty else 0,
                  "fotmob_starts_recent": f["fotmob_starts_recent"].iloc[0] if not f.empty else 0,
                  "fotmob_role": f["fotmob_role"].iloc[0] if not f.empty else "",
                  "fotmob_availability": f["fotmob_availability"].iloc[0] if not f.empty else "",
              })

          outdf = pd.DataFrame(out_rows)
          outdf.to_csv("expected_stats_latest.csv", index=False)
          print("Created expected_stats_latest.csv with", len(outdf), "rows")
          EOF

      # -------------------------------------------------------
      # 5. Run engine
      # -------------------------------------------------------
      - name: Run FPL engine
        run: python engine_gw13.py

      # -------------------------------------------------------
      # 6. Generate plain-text summary for email (pure Python)
      # -------------------------------------------------------
      - name: Build email summary
        id: summary
        run: |
          python - << 'EOF'
          import glob
          import os
          from pathlib import Path

          import pandas as pd

          lines = ["FPL Engine Summary", ""]

          # Captain suggestion
          myteam_files = glob.glob("gw*_predictions_myteam.csv")
          if myteam_files:
              df = pd.read_csv(myteam_files[0])
              if "multi_gw_points" in df.columns:
                  df = df.sort_values("multi_gw_points", ascending=False)
                  top = df.iloc[0]
                  lines.append(
                      f"Suggested Captain: {top.web_name} ({top.team_short}) — {top.multi_gw_points:.2f} pts"
                  )
                  lines.append("")
              else:
                  lines.append("Captain suggestion unavailable (multi_gw_points missing).")
                  lines.append("")

          # Single-transfer suggestion
          single_files = glob.glob("gw*_transfer_suggestions.csv")
          if single_files:
              df = pd.read_csv(single_files[0])
              if not df.empty:
                  top = df.iloc[0]
                  lines.append("Top Single Transfer:")
                  lines.append(
                      f"Sell {top.sell_name} → Buy {top.buy_name} (Gain: {top.gain:.2f})"
                  )
                  lines.append("")

          # Double-transfer suggestion
          double_files = glob.glob("gw*_double_transfers.csv")
          if double_files:
              df = pd.read_csv(double_files[0])
              if not df.empty:
                  top = df.iloc[0]
                  lines.append("Top Double Transfer:")
                  lines.append(
                      f"Sell {top.sell1} & {top.sell2} → Buy {top.buy1} & {top.buy2} (Net Gain: {top.net_gain:.2f})"
                  )
                  lines.append("")

          summary_text = "\n".join(lines)

          # Write to file for debugging
          Path("summary.txt").write_text(summary_text, encoding="utf-8")

          # Expose via GITHUB_OUTPUT
          gh_out = os.environ.get("GITHUB_OUTPUT")
          if gh_out:
              with open(gh_out, "a", encoding="utf-8") as f:
                  print("summary_out<<EOF", file=f)
                  f.write(summary_text + "\n")
                  print("EOF", file=f)

          print(summary_text)
          EOF

      # -------------------------------------------------------
      # 7. ZIP outputs
      # -------------------------------------------------------
      - name: Zip outputs
        run: |
          mkdir -p artifacts
          zip artifacts/fpl-engine-csvs.zip *.csv

      # -------------------------------------------------------
      # 8. Upload artifacts
      # -------------------------------------------------------
      - name: Upload CSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fpl-engine-csvs
          path: artifacts/fpl-engine-csvs.zip

      # -------------------------------------------------------
      # 9. Email results
      # -------------------------------------------------------
      - name: Email results
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: starttls
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          from: ${{ secrets.EMAIL_FROM }}
          to: ${{ secrets.EMAIL_TO }}
          subject: "FPL Engine Results (Run #${{ github.run_number }})"
          body: |
            Your FPL engine run has completed.

            =============================
            FPL SUMMARY
            =============================

            ${{ steps.summary.outputs.summary_out }}

            -----------------------------
            Full run details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            CSV outputs are attached.
          attachments: artifacts/fpl-engine-csvs.zip
